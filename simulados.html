<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulados ENEM - Acompanhamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #ff6b9e;
            --secondary-color: #d23369;
            --background-color: #fff5f7;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #ffd6e7;
            
            --horrible-color: #000000; --bad-color: #e63946; --ok-color: #f4a261;
            --good-color: #ffd166; --excellent-color: #06d6a0; --perfect-color: #118ab2;
            --danger-color: #d23369; --nav-bg: #d23369;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; margin-bottom: 30px; padding: 20px; background-color: var(--primary-color); color: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1 { font-size: 2.2rem; margin-bottom: 10px; }
        .navigation { display: flex; background-color: var(--nav-bg); padding: 15px; justify-content: center; margin-bottom: 20px; border-radius: 10px; }
        .nav-btn { background: none; border: none; color: white; padding: 10px 20px; margin: 0 10px; cursor: pointer; font-size: 1.1rem; border-radius: 5px; transition: all 0.3s; }
        .nav-btn.active { background-color: var(--primary-color); font-weight: bold; }
        .nav-btn:hover:not(.active) { background-color: rgba(255, 255, 255, 0.2); }
        .page { display: none; }
        .page.active { display: block; }
        .add-simulado-btn { display: flex; align-items: center; justify-content: center; background-color: var(--primary-color); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; position: fixed; bottom: 30px; right: 30px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; z-index: 100; }
        .add-simulado-btn:hover { background-color: var(--secondary-color); transform: scale(1.1); }
        .add-simulado-btn:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: var(--primary-color); }
        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color); position: absolute; top: 15px; right: 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 16px; }
        .form-group input[type="number"] { -moz-appearance: textfield; }
        .form-group input[type="number"]::-webkit-outer-spin-button, .form-group input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .dia-fields { display: none; }
        .dia-fields.active { display: block; }
        .submit-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.3s; }
        .submit-btn:hover { background-color: var(--secondary-color); }
        .delete-btn { background-color: var(--danger-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s; margin-right: 10px; }
        .delete-btn:hover { background-color: #b02323; }
        .edit-btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; transition: background-color 0.3s; }
        .edit-btn:hover { background-color: var(--secondary-color); }
        .simulados-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 30px; }
        .simulado-card { background-color: var(--card-color); border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(210, 51, 105, 0.1); transition: transform 0.3s, box-shadow 0.3s; position: relative; border: 1px solid var(--border-color); }
        .simulado-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(210, 51, 105, 0.2); }
        .simulado-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .simulado-title { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
        .simulado-date { font-size: 0.9rem; color: #666; }
        .simulado-details { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .simulado-area { text-align: center; }
        .simulado-area-name { font-size: 0.9rem; color: #666; }
        .simulado-area-score { font-size: 1.2rem; font-weight: 600; }
        .simulado-total { text-align: center; margin: 15px 0; font-size: 1.3rem; font-weight: 600; }
        .progress-container { height: 20px; background-color: var(--border-color); border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 10px; transition: width 0.5s ease; }
        .performance-text { text-align: center; font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; }
        .card-actions { display: flex; justify-content: flex-end; margin-top: 10px; }
        .horrible { background-color: var(--horrible-color); color: white; } .bad { background-color: var(--bad-color); color: white; }
        .ok { background-color: var(--ok-color); } .good { background-color: var(--good-color); }
        .excellent { background-color: var(--excellent-color); color: white; } .perfect { background-color: var(--perfect-color); color: white; }
        .save-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--primary-color); color: white; padding: 10px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); opacity: 0; transition: opacity 0.3s; z-index: 1000; }
        .save-message.show { opacity: 1; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 40px 20px; background-color: var(--card-color); border-radius: 10px; border: 1px dashed var(--border-color); }
        .empty-state i { font-size: 2.5rem; color: var(--primary-light); margin-bottom: 15px; }
        .empty-state h3 { font-size: 1.3rem; color: var(--primary-dark); margin-bottom: 10px; }

        .chart-container { background-color: white; border-radius: 10px; padding: 20px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(210, 51, 105, 0.1); border: 1px solid var(--border-color); height: 400px; position: relative; }
        .chart-title { text-align: center; margin-bottom: 20px; color: var(--primary-color); font-size: 1.3rem; }
        @media (max-width: 768px) { .simulados-container { grid-template-columns: 1fr; } .navigation { flex-direction: column; align-items: center; } .nav-btn { margin: 5px 0; width: 100%; } .chart-container { height: 300px; } }
    </style>
</head>
<body>
    <div class="navigation">
        <button class="nav-btn active" id="simuladosBtn">Simulados</button>
        <button class="nav-btn" id="desempenhosBtn">Desempenhos</button>
    </div>

    <div class="container">
        <header>
            <h1>Simulados ENEM</h1>
            <p>Acompanhe seu desempenho nos simulados</p>
        </header>

        <div class="page active" id="simuladosPage">
            <div class="simulados-container" id="simuladosContainer">
                <!-- Cards de simulados -->
            </div>
            <button class="add-simulado-btn" id="addSimuladoBtn" disabled>
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div class="page" id="desempenhosPage">
            <div class="chart-container">
                <h2 class="chart-title">Desempenho nos Simulados - Dia 1 (Linguagens e Humanas)</h2>
                <canvas id="dia1Chart"></canvas>
            </div>
            <div class="chart-container">
                <h2 class="chart-title">Desempenho nos Simulados - Dia 2 (Natureza e Matemática)</h2>
                <canvas id="dia2Chart"></canvas>
            </div>
        </div>

        <div class="modal" id="addSimuladoModal">
            <div class="modal-content">
                <button class="close-modal" id="closeModal">×</button>
                <div class="modal-header"> <h2 id="modalTitle">Adicionar Simulado</h2> </div>
                <form id="simuladoForm">
                    <input type="hidden" id="simuladoId">
                    <div class="form-group">
                        <label for="simuladoType">Tipo de simulado</label>
                        <select id="simuladoType" required>
                            <option value="">Selecione...</option> <option value="Sas">Sas</option> <option value="Poliedro">Poliedro</option>
                            <option value="Hexag">Hexag</option> <option value="Somos">Somos</option>
                            <option value="Bernoulli">Bernoulli</option> <option value="Prova antiga">Prova antiga</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="simuladoDia">Dia</label>
                        <select id="simuladoDia" required>
                            <option value="">Selecione...</option> <option value="Dia 1">Dia 1</option> <option value="Dia 2">Dia 2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="simuladoDate">Data de realização</label>
                        <input type="date" id="simuladoDate" required>
                    </div>
                    <div id="dia1Fields" class="dia-fields">
                        <div class="form-group"> <label for="linguagensAcertos">Acertos em Linguagens (0-45)</label> <input type="number" id="linguagensAcertos" min="0" max="45"> </div>
                        <div class="form-group"> <label for="humanasAcertos">Acertos em Humanas (0-45)</label> <input type="number" id="humanasAcertos" min="0" max="45"> </div>
                    </div>
                    <div id="dia2Fields" class="dia-fields">
                        <div class="form-group"> <label for="naturezaAcertos">Acertos em Natureza (0-45)</label> <input type="number" id="naturezaAcertos" min="0" max="45"> </div>
                        <div class="form-group"> <label for="matematicaAcertos">Acertos em Matemática (0-45)</label> <input type="number" id="matematicaAcertos" min="0" max="45"> </div>
                    </div>
                    <button type="submit" class="submit-btn" id="submitBtn">Adicionar Simulado</button>
                </form>
            </div>
        </div>
        <div class="save-message" id="saveMessage">Progresso salvo com sucesso!</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // ######### INÍCIO DA SEÇÃO DE CONFIGURAÇÃO DO FIREBASE #########
        const firebaseConfig = {
            apiKey: "AIzaSyD6msk2NG3gfyPKhjZJ4HB1X6SJ8ICzSMg",
            authDomain: "painel-de-controle-para-o-enem.firebaseapp.com",
            projectId: "painel-de-controle-para-o-enem",
            storageBucket: "painel-de-controle-para-o-enem.firebasestorage.app",
            messagingSenderId: "144604369875",
            appId: "1:144604369875:web:c113d74ba1b0ddd1629526",
            measurementId: "G-W7PM1J1FNN"
        };
        // ######### FIM DA SEÇÃO DE CONFIGURAÇÃO DO FIREBASE #########

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUserUID = null;

        let simulados = []; // Não carrega mais do localStorage
        let editingSimuladoId = null;
        let dia1ChartInstance = null; // Renomeado para evitar conflito com ID do canvas
        let dia2ChartInstance = null; // Renomeado
        let saveMessageTimeoutId = null;

        const simuladosBtn = document.getElementById('simuladosBtn');
        const desempenhosBtn = document.getElementById('desempenhosBtn');
        const simuladosPage = document.getElementById('simuladosPage');
        const desempenhosPage = document.getElementById('desempenhosPage');
        const addSimuladoBtn = document.getElementById('addSimuladoBtn');
        const addSimuladoModal = document.getElementById('addSimuladoModal');
        const closeModalBtn = document.getElementById('closeModal'); // Renomeado para não conflitar
        const simuladoForm = document.getElementById('simuladoForm');
        const simuladoDiaSelect = document.getElementById('simuladoDia'); // Renomeado
        const dia1Fields = document.getElementById('dia1Fields');
        const dia2Fields = document.getElementById('dia2Fields');
        const simuladosContainer = document.getElementById('simuladosContainer');
        const modalTitle = document.getElementById('modalTitle');
        const submitBtn = document.getElementById('submitBtn');
        const simuladoIdInput = document.getElementById('simuladoId');
        const saveMessageEl = document.getElementById('saveMessage'); // Renomeado
        const dia1ChartCanvas = document.getElementById('dia1Chart');
        const dia2ChartCanvas = document.getElementById('dia2Chart');

        simuladosBtn.addEventListener('click', () => {
            simuladosBtn.classList.add('active'); desempenhosBtn.classList.remove('active');
            simuladosPage.classList.add('active'); desempenhosPage.classList.remove('active');
        });

        desempenhosBtn.addEventListener('click', () => {
            desempenhosBtn.classList.add('active'); simuladosBtn.classList.remove('active');
            desempenhosPage.classList.add('active'); simuladosPage.classList.remove('active');
            updateCharts();
        });

        addSimuladoBtn.addEventListener('click', () => {
            if (!currentUserUID) {
                alert("Você precisa estar logado para adicionar simulados."); return;
            }
            editingSimuladoId = null;
            modalTitle.textContent = 'Adicionar Simulado';
            submitBtn.textContent = 'Adicionar Simulado';
            simuladoForm.reset();
            dia1Fields.classList.remove('active'); dia2Fields.classList.remove('active');
            addSimuladoModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', () => { addSimuladoModal.style.display = 'none'; });
        window.addEventListener('click', (e) => { if (e.target === addSimuladoModal) addSimuladoModal.style.display = 'none'; });

        simuladoDiaSelect.addEventListener('change', (e) => {
            dia1Fields.classList.remove('active'); dia2Fields.classList.remove('active');
            if (e.target.value === 'Dia 1') dia1Fields.classList.add('active');
            else if (e.target.value === 'Dia 2') dia2Fields.classList.add('active');
        });

        simuladoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserUID) { alert("Você precisa estar logado para salvar."); return; }

            const type = document.getElementById('simuladoType').value;
            const dia = simuladoDiaSelect.value;
            const dateString = document.getElementById('simuladoDate').value;
            let linguagens = 0, humanas = 0, natureza = 0, matematica = 0;

            if (!type || !dia || !dateString) {
                alert("Preencha o tipo, dia e data do simulado."); return;
            }

            if (dia === 'Dia 1') {
                linguagens = parseInt(document.getElementById('linguagensAcertos').value) || 0;
                humanas = parseInt(document.getElementById('humanasAcertos').value) || 0;
                if (linguagens < 0 || linguagens > 45 || humanas < 0 || humanas > 45) {
                    alert("Número de acertos inválido para Dia 1 (deve ser entre 0 e 45)."); return;
                }
            } else {
                natureza = parseInt(document.getElementById('naturezaAcertos').value) || 0;
                matematica = parseInt(document.getElementById('matematicaAcertos').value) || 0;
                if (natureza < 0 || natureza > 45 || matematica < 0 || matematica > 45) {
                    alert("Número de acertos inválido para Dia 2 (deve ser entre 0 e 45)."); return;
                }
            }
            const total = linguagens + humanas + natureza + matematica;

            const simuladoData = {
                type, dia,
                date: firebase.firestore.Timestamp.fromDate(new Date(dateString + "T00:00:00Z")),
                linguagens, humanas, natureza, matematica, total,
                ownerUID: currentUserUID,
            };

            try {
                const userSimuladosCollection = db.collection("users").doc(currentUserUID).collection("simulados");
                if (editingSimuladoId) {
                    simuladoData.lastModifiedTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                    const simuladoExistente = simulados.find(s => s.id === editingSimuladoId);
                    simuladoData.addedTimestamp = simuladoExistente?.addedTimestamp || firebase.firestore.FieldValue.serverTimestamp(); // Preserva ou define
                    
                    await userSimuladosCollection.doc(editingSimuladoId).set(simuladoData, {merge: true});
                    showSaveMessage('Simulado atualizado com sucesso!');
                } else {
                    simuladoData.addedTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                    simuladoData.lastModifiedTimestamp = firebase.firestore.FieldValue.serverTimestamp();
                    await userSimuladosCollection.add(simuladoData);
                    showSaveMessage('Simulado adicionado com sucesso!');
                }
                await loadSimulados();
                addSimuladoModal.style.display = 'none';
                simuladoForm.reset();
                dia1Fields.classList.remove('active'); dia2Fields.classList.remove('active');
            } catch (error) {
                console.error("Erro ao salvar simulado:", error);
                showSaveMessage("Erro ao salvar simulado.", "error");
            }
            editingSimuladoId = null;
        });

        function editSimulado(id) {
            if (!currentUserUID) { alert("Você precisa estar logado para editar."); return; }
            const simulado = simulados.find(s => s.id === id);
            if (!simulado) return;

            editingSimuladoId = id;
            modalTitle.textContent = 'Editar Simulado';
            submitBtn.textContent = 'Salvar Alterações';
            document.getElementById('simuladoType').value = simulado.type;
            simuladoDiaSelect.value = simulado.dia;
            document.getElementById('simuladoDate').value = simulado.date.toISOString().split('T')[0]; // Timestamp para string YYYY-MM-DD
            simuladoIdInput.value = simulado.id;

            dia1Fields.classList.remove('active'); dia2Fields.classList.remove('active');
            if (simulado.dia === 'Dia 1') {
                document.getElementById('linguagensAcertos').value = simulado.linguagens;
                document.getElementById('humanasAcertos').value = simulado.humanas;
                dia1Fields.classList.add('active');
            } else {
                document.getElementById('naturezaAcertos').value = simulado.natureza;
                document.getElementById('matematicaAcertos').value = simulado.matematica;
                dia2Fields.classList.add('active');
            }
            addSimuladoModal.style.display = 'flex';
        }

        async function deleteSimulado(id) {
            if (!currentUserUID) { alert("Você precisa estar logado para excluir."); return; }
            if (confirm('Tem certeza que deseja excluir este simulado?')) {
                try {
                    await db.collection("users").doc(currentUserUID).collection("simulados").doc(id).delete();
                    await loadSimulados();
                    showSaveMessage('Simulado excluído com sucesso!');
                } catch (error) {
                    console.error("Erro ao excluir simulado:", error);
                    showSaveMessage("Erro ao excluir simulado.", "error");
                }
            }
        }
        
        function showSaveMessage(message = 'Operação realizada com sucesso!', type = 'success') {
            saveMessageEl.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
            saveMessageEl.className = `save-message ${type === 'error' ? 'error-msg' : ''}`;
            saveMessageEl.classList.remove('show');
            void saveMessageEl.offsetWidth;
            saveMessageEl.classList.add('show');
            if (saveMessageTimeoutId) clearTimeout(saveMessageTimeoutId);
            saveMessageTimeoutId = setTimeout(() => { saveMessageEl.classList.remove('show'); }, 3000);
        }

        function getPerformanceClass(total) {
            if (total <= 30) return 'horrible'; if (total <= 50) return 'bad';
            if (total <= 60) return 'ok'; if (total <= 70) return 'good';
            if (total <= 80) return 'excellent'; return 'perfect';
        }
        function getPerformanceText(total) {
            if (total <= 30) return 'Horrível'; if (total <= 50) return 'Ruim';
            if (total <= 60) return 'Ok'; if (total <= 70) return 'Bom';
            if (total <= 80) return 'Excelente'; return 'Perfeito';
        }
        function getPerformanceColor(total) {
            if (total <= 30) return '#000000'; if (total <= 50) return '#e63946';
            if (total <= 60) return '#f4a261'; if (total <= 70) return '#ffd166';
            if (total <= 80) return '#06d6a0'; return '#118ab2';
        }
        function formatDate(dateObj) { // Recebe objeto Date ou Timestamp
            if (dateObj && dateObj.toDate) { // Se for Timestamp do Firestore
                return dateObj.toDate().toLocaleDateString('pt-BR', { timeZone: 'UTC' }); // Adicionado UTC para consistência
            } else if (dateObj instanceof Date) { // Se já for Date
                return dateObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            }
            return 'Data inválida';
        }


        function renderSimulados() {
            simuladosContainer.innerHTML = '';
             if (!currentUserUID && simulados.length === 0) {
                simuladosContainer.innerHTML = `<div class="empty-state"><i class="fas fa-sign-in-alt"></i><h3>Faça login para ver seus simulados</h3><p>Os simulados são salvos na nuvem e associados à sua conta.</p></div>`;
                addSimuladoBtn.disabled = true;
                return;
            } else if (currentUserUID) {
                 addSimuladoBtn.disabled = false;
            }

            if (simulados.length === 0 && currentUserUID) {
                simuladosContainer.innerHTML = `<div class="empty-state"><i class="fas fa-file-alt"></i><h3>Nenhum simulado cadastrado</h3><p>Clique no botão "+" para adicionar seu primeiro simulado!</p></div>`;
                return;
            }

            const sortedSimulados = [...simulados].sort((a, b) => b.date.getTime() - a.date.getTime());

            sortedSimulados.forEach(simulado => {
                const card = document.createElement('div');
                card.className = 'simulado-card';
                const performanceClass = getPerformanceClass(simulado.total);
                const percentage = (simulado.total / (simulado.dia === 'Dia 1' || simulado.dia === 'Dia 2' ? 90 : 180)) * 100; // Ajuste se tiver simulado completo

                card.innerHTML = `
                    <div class="simulado-header">
                        <div class="simulado-title">${simulado.type} - ${simulado.dia}</div>
                        <div class="simulado-date">${formatDate(simulado.date)}</div>
                    </div>
                    <div class="simulado-details">
                        ${simulado.dia === 'Dia 1' ? `
                            <div class="simulado-area"><div class="simulado-area-name">Linguagens</div><div class="simulado-area-score">${simulado.linguagens}/45</div></div>
                            <div class="simulado-area"><div class="simulado-area-name">Humanas</div><div class="simulado-area-score">${simulado.humanas}/45</div></div>
                        ` : simulado.dia === 'Dia 2' ? `
                            <div class="simulado-area"><div class="simulado-area-name">Natureza</div><div class="simulado-area-score">${simulado.natureza}/45</div></div>
                            <div class="simulado-area"><div class="simulado-area-name">Matemática</div><div class="simulado-area-score">${simulado.matematica}/45</div></div>
                        ` : `<p>Detalhes não disponíveis para este tipo de dia.</p>`}
                    </div>
                    <div class="simulado-total">Total: ${simulado.total}/${(simulado.dia === 'Dia 1' || simulado.dia === 'Dia 2' ? 90 : 180)}</div>
                    <div class="progress-container"><div class="progress-bar ${performanceClass}" style="width: ${percentage}%"></div></div>
                    <div class="performance-text ${performanceClass}">${getPerformanceText(simulado.total)}</div>
                    <div class="card-actions">
                        <button class="delete-btn" onclick="deleteSimulado('${simulado.id}')"><i class="fas fa-trash"></i> Excluir</button>
                        <button class="edit-btn" onclick="editSimulado('${simulado.id}')"><i class="fas fa-edit"></i> Editar</button>
                    </div>
                `;
                simuladosContainer.appendChild(card);
            });
            updateCharts(); // Atualiza os gráficos após renderizar os simulados
        }

        function updateCharts() {
            const simuladosDia1 = simulados.filter(s => s.dia === 'Dia 1').sort((a, b) => a.date.getTime() - b.date.getTime());
            const simuladosDia2 = simulados.filter(s => s.dia === 'Dia 2').sort((a, b) => a.date.getTime() - b.date.getTime());

            const dia1Labels = simuladosDia1.map(s => `${s.type} (${formatDate(s.date).substring(0,5)})`); // Data mais curta
            const dia1Totais = simuladosDia1.map(s => s.linguagens + s.humanas);
            const dia1Colors = simuladosDia1.map(s => getPerformanceColor(s.linguagens + s.humanas));

            const dia2Labels = simuladosDia2.map(s => `${s.type} (${formatDate(s.date).substring(0,5)})`);
            const dia2Totais = simuladosDia2.map(s => s.natureza + s.matematica);
            const dia2Colors = simuladosDia2.map(s => getPerformanceColor(s.natureza + s.matematica));

            if (dia1ChartInstance) dia1ChartInstance.destroy();
            if (dia2ChartInstance) dia2ChartInstance.destroy();

            const chartOptions = {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 90, title: { display: true, text: 'Total de Acertos', font: { size: 14 } }, ticks: { font: { size: 12 } } },
                    x: { title: { display: true, text: 'Simulados', font: { size: 14 } }, ticks: { font: { size: 12 } } }
                },
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `Total: ${ctx.raw}` } } }
            };

            if (dia1ChartCanvas.getContext('2d') && simuladosDia1.length > 0) {
                dia1ChartInstance = new Chart(dia1ChartCanvas, {
                    type: 'bar',
                    data: { labels: dia1Labels, datasets: [{ label: 'Total de Acertos', data: dia1Totais, backgroundColor: dia1Colors, borderWidth: 1, borderRadius: 4, barPercentage: 0.8 }] },
                    options: chartOptions
                });
            }
             if (dia2ChartCanvas.getContext('2d') && simuladosDia2.length > 0) {
                dia2ChartInstance = new Chart(dia2ChartCanvas, {
                    type: 'bar',
                    data: { labels: dia2Labels, datasets: [{ label: 'Total de Acertos', data: dia2Totais, backgroundColor: dia2Colors, borderWidth: 1, borderRadius: 4, barPercentage: 0.8 }] },
                    options: chartOptions
                });
            }
        }

        async function loadSimulados() {
            if (!currentUserUID) {
                simulados = []; renderSimulados(); return;
            }
            try {
                const simuladosCollectionRef = db.collection("users").doc(currentUserUID).collection("simulados");
                const snapshot = await simuladosCollectionRef.orderBy("date", "desc").get(); // Ordena por data do Firestore
                simulados = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id, ...data,
                        date: data.date.toDate() // Converte Timestamp para objeto Date
                    };
                });
            } catch (error) {
                console.error("Erro ao carregar simulados:", error);
                showSaveMessage("Erro ao carregar seus simulados.", "error");
                simulados = [];
            }
            renderSimulados(); // renderSimulados agora também chama updateCharts
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            addSimuladoBtn.disabled = true; // Começa desabilitado
            auth.onAuthStateChanged(async user => {
                if (user && user.emailVerified) {
                    currentUserUID = user.uid;
                    addSimuladoBtn.disabled = false;
                    await loadSimulados();
                } else {
                    currentUserUID = null;
                    simulados = [];
                    renderSimulados(); // Mostrará mensagem para fazer login
                    addSimuladoBtn.disabled = true;
                    console.warn("simulados.html: Usuário não autenticado ou e-mail não verificado.");
                }
            });
        });
    </script>
</body>
</html>